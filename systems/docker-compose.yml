version: "3.9"

volumes:
  postgress-data:

services:

  rabbitmq:
    image: rabbitmq:3-management
    ports:
        - 5672:5672
        - 15672:15672
    volumes:
        - ~/.docker-conf/rabbitmq/data/:/var/lib/rabbitmq/
        - ~/.docker-conf/rabbitmq/log/:/var/log/rabbitmq


  postgresd:
    image: postgres:13.3
    ports:
      - "15432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=ThisIsUkamaXPass
    volumes:
      - postgress-data:/var/lib/postgresql



# Registry System

  registry:
    build: ./registry/api-gateway
    ports:
      - "8380:8080"
    restart: always
    depends_on:
      - postgresd
      - org
      - users
      - network


  msg-client-registry:
    build: ./messaging/msgClient
    ports:
      - "9390:9095"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - MSGCLIENT_HOST=msg-client-registry:9095
      - SYSTEM=registry
    restart: always
    depends_on:
      - postgresd


  org:
    build: ./registry/org
    ports:
      - "9391:9090"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - MSGCLIENT_HOST=msg-client-registry:9095
      - ORG_SERVICE_HOST=org
      - ORG_SERVICE_PORT=9090
      - ORGOWNERUUID=851e0abc-7e91-4206-8c85-498e16f91e67
    restart: always
    depends_on:
      - postgresd


  users:
    build: ./registry/users
    ports:
      - "9392:9090"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - MSGCLIENT_HOST=msg-client-registry:9095
      - USERS_SERVICE_HOST=users
      - USERS_SERVICE_PORT=9090
      - ORGOWNERUUID=851e0abc-7e91-4206-8c85-498e16f91e67
    restart: always
    depends_on:
      - postgresd


  network:
    build: ./registry/network
    ports:
      - "9393:9090"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - MSGCLIENT_HOST=msg-client-registry:9095
      - NETWORK_SERVICE_HOST=network
      - NETWORK_SERVICE_PORT=9090
    restart: always
    depends_on:
      - postgresd



# Data Plan System

  data-plan:
    build: ./data-plan/api-gateway
    ports:
      - "8480:8080"
    restart: always
    depends_on:
      - postgresd
      - package


  msg-client-dataplan:
    build: ./messaging/msgClient
    ports:
      - "9490:9095"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - MSGCLIENT_HOST=msg-client-dataplan:9095
      - SYSTEM=dataplan
    restart: always
    depends_on:
      - postgresd


  rate:
    build: ./data-plan/base-rate
    ports:
      - "9491:9090"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - MSGCLIENT_HOST=msg-client-dataplan:9095
      - RATE_SERVICE_HOST=rate
      - RATE_SERVICE_PORT=9090
    restart: always
    depends_on:
      - postgresd


  package:
    build: ./data-plan/package
    ports:
      - "9492:9090"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - MSGCLIENT_HOST=msg-client-dataplan:9095
      - PACKAGE_SERVICE_HOST=package
      - PACKAGE_SERVICE_PORT=9090
    restart: always
    depends_on:
      - postgresd



# Subscriber System

  subscriber:
    build: ./subscriber/api-gateway
    ports:
      - "8580:8080"
    restart: always
    depends_on:
      - postgresd
      - sim
      - subscriber-registry
      - simmanager
      - testagent


  msg-client-subscriber:
    build: ./messaging/msgClient
    ports:
      - "9590:9095"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - MSGCLIENT_HOST=msg-client-subscriber:9095
      - SYSTEM=subscriber
    restart: always
    depends_on:
      - postgresd


  sim:
    build: ./subscriber/sim-pool
    ports:
      - "9591:9090"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - MSGCLIENT_HOST=msg-client-subscriber:9095
      - SIM_SERVICE_HOST=sim
      - SIM_SERVICE_PORT=9090
    restart: always
    depends_on:
      - postgresd


  subscriber-registry:
    build: ./subscriber/registry
    ports:
      - "9592:9090"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - MSGCLIENT_HOST=msg-client-subscriber:9095
      - REGISTRY_SERVICE_HOST=subscriber-registry
      - REGISTRY_SERVICE_PORT=9090
    restart: always
    depends_on:
      - postgresd


  simmanager:
    build: ./subscriber/sim-manager
    ports:
      - "9593:9090"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - KEY=${KEY}
      - MSGCLIENT_HOST=msg-client-subscriber:9095
      - SIMMANAGER_SERVICE_HOST=simmanager
      - SIMMANAGER_SERVICE_PORT=9090
    restart: always
    depends_on:
      - postgresd


  testagent:
    build: ./subscriber/test-agent
    ports:
      - "9594:9090"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - MSGCLIENT_HOST=msg-client-subscriber:9095
      - TESTAGENT_SERVICE_HOST=testagent
      - TESTAGENT_SERVICE_PORT=9090
    restart: always
    depends_on:
      - postgresd



# Billing System

  msg-client-billing:
    build: ./messaging/msgClient
    ports:
      - "9690:9095"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - MSGCLIENT_HOST=msg-client-billing:9095
      - SYSTEM=billing
    restart: always
    depends_on:
      - postgresd


  billing-exporter:
    build: ./billing/exporter
    ports:
      - "9691:9090"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - MSGCLIENT_HOST=msg-client-billing:9095
      - EXPORTER_SERVICE_HOST=billing-exporter
      - EXPORTER_SERVICE_PORT=9090
      - LAGOAPIKEY=b24f7d88-4072-4866-9bbf-5dadd1970597
      - LAGOHOST=${DOCKER_HOST_IP}
    restart: always
    depends_on:
      - postgresd


  billing-invoice:
    build: ./billing/invoice
    ports:
      - "9692:9090"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - MSGCLIENT_HOST=msg-client-billing:9095
      - INVOICE_SERVICE_HOST=billing-invoice
      - INVOICE_SERVICE_PORT=9090
    restart: always
    depends_on:
      - postgresd




# Operator System

  msg-client-telna:
    build: ./messaging/msgClient
    ports:
      - "9790:9095"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - MSGCLIENT_HOST=msg-client-telna:9095
      - SYSTEM=telna
    restart: always
    depends_on:
      - postgresd


  telna-cdr:
    build: ../../telna-agent/cdr
    ports:
      - "9791:9090"
    environment:
      - DEBUGMODE=true
      - DB_HOST=postgresd
      - DB_PASSWORD=ThisIsUkamaXPass
      - DB_USER=postgres
      - QUEUE_URI=amqp://guest:guest@rabbitmq:5672
      - MSGCLIENT_HOST=msg-client-telna:9095
      - CDR_SERVICE_HOST=telna-cdr
      - CDR_SERVICE_PORT=9090
      - SCHEDULERINTERVAL
    restart: always
    depends_on:
      - postgresd
