FROM node:24-bullseye-slim AS base

# Install pnpm globally with the same version as local (10.11.0) and retry options
RUN npm config set registry https://registry.npmjs.org/ && \
    npm config set fetch-retry-mintimeout 20000 && \
    npm config set fetch-retry-maxtimeout 120000 && \
    npm config set fetch-timeout 300000 && \
    npm install -g pnpm@10.11.0

FROM base AS builder

WORKDIR /app

# Install dependencies first
COPY package.json pnpm-lock.yaml* pnpm-workspace.yaml* ./

# Configure pnpm and install dependencies
RUN pnpm config set fetch-retry-mintimeout 20000 && \
    pnpm config set fetch-retry-maxtimeout 120000 && \
    pnpm config set fetch-timeout 300000 && \
    pnpm install --frozen-lockfile --ignore-scripts

# Copy source files
COPY src ./src
COPY public ./public
COPY next.config.mjs .
COPY tsconfig.json .

# Set environment variables
ARG NEXT_PUBLIC_NODE_ENV
ENV NEXT_PUBLIC_NODE_ENV=${NEXT_PUBLIC_NODE_ENV}
ARG NEXT_PUBLIC_APP_URL
ENV NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
ARG NEXT_PUBLIC_AUTH_APP_URL
ENV NEXT_PUBLIC_AUTH_APP_URL=${NEXT_PUBLIC_AUTH_APP_URL}
ARG NEXT_PUBLIC_API_GW
ENV NEXT_PUBLIC_API_GW=${NEXT_PUBLIC_API_GW}
ARG NEXT_PUBLIC_METRIC_URL
ENV NEXT_PUBLIC_METRIC_URL=${NEXT_PUBLIC_METRIC_URL}
ARG NEXT_PUBLIC_METRIC_WEBSOCKET_URL
ENV NEXT_PUBLIC_METRIC_WEBSOCKET_URL=${NEXT_PUBLIC_METRIC_WEBSOCKET_URL}
ARG NEXT_PUBLIC_MAP_BOX_TOKEN
ENV NEXT_PUBLIC_MAP_BOX_TOKEN=${NEXT_PUBLIC_MAP_BOX_TOKEN}
ARG NEXT_PUBLIC_API_GW_4SS
ENV NEXT_PUBLIC_API_GW_4SS=${NEXT_PUBLIC_API_GW_4SS}
ARG NEXT_PUBLIC_SIM_TYPE
ENV NEXT_PUBLIC_SIM_TYPE=${NEXT_PUBLIC_SIM_TYPE}
ARG NEXT_PUBLIC_APP_DOMAIN
ENV NEXT_PUBLIC_APP_DOMAIN=${NEXT_PUBLIC_APP_DOMAIN}
ENV NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
ARG NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY

# Build the application
RUN pnpm run build

FROM base AS runner

WORKDIR /app

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs
USER nextjs

COPY --from=builder /app/public ./public

COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# Set environment variables in runner
ARG NEXT_PUBLIC_NODE_ENV
ENV NEXT_PUBLIC_NODE_ENV=${NEXT_PUBLIC_NODE_ENV}
ARG NEXT_PUBLIC_APP_URL
ENV NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
ARG NEXT_PUBLIC_AUTH_APP_URL
ENV NEXT_PUBLIC_AUTH_APP_URL=${NEXT_PUBLIC_AUTH_APP_URL}
ARG NEXT_PUBLIC_API_GW
ENV NEXT_PUBLIC_API_GW=${NEXT_PUBLIC_API_GW}
ARG NEXT_PUBLIC_METRIC_URL
ENV NEXT_PUBLIC_METRIC_URL=${NEXT_PUBLIC_METRIC_URL}
ARG NEXT_PUBLIC_METRIC_WEBSOCKET_URL
ENV NEXT_PUBLIC_METRIC_WEBSOCKET_URL=${NEXT_PUBLIC_METRIC_WEBSOCKET_URL}
ARG NEXT_PUBLIC_MAP_BOX_TOKEN
ENV NEXT_PUBLIC_MAP_BOX_TOKEN=${NEXT_PUBLIC_MAP_BOX_TOKEN}
ARG NEXT_PUBLIC_API_GW_4SS
ENV NEXT_PUBLIC_API_GW_4SS=${NEXT_PUBLIC_API_GW_4SS}
ARG NEXT_PUBLIC_SIM_TYPE
ENV NEXT_PUBLIC_SIM_TYPE=${NEXT_PUBLIC_SIM_TYPE}
ARG NEXT_PUBLIC_APP_DOMAIN
ENV NEXT_PUBLIC_APP_DOMAIN=${NEXT_PUBLIC_APP_DOMAIN}
ARG NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
ENV NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}

EXPOSE 8080

CMD ["pnpm", "start"]