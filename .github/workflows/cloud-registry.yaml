# THIS FILE IS GENERATED AUTOMATICALLY BY RUNNING gen-workflow.sh 
# DON'T CHANGE IT MANUALLY TO AVOID YOUR CHANGES BEING OVERWRITTEN
# USE workflow-template.yaml FOR MAKING CHANGES IN WORKFLOWS
name: build-registry
on:  
  push:   
    paths:
        - "cloud/registry/**"
        - ".github/workflows/cloud-registry.yaml"

jobs:  
  build:
    env: 
      working-directory: cloud/registry

    name: build and test
    runs-on: ubuntu-latest    
    steps:
    - uses: actions/checkout@v2
  
      # init vars required for tag generation
    - name: Init vars 
      id: vars_step
      run: |
          echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"
          echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.16
      
    - name: Granting private modules access
      run: |
          git config --global url."https://none:${{ secrets.GIT_ACCESS_TOKEN }}@github.com/ukama".insteadOf "https://github.com/ukama"     

    - name: Setup protoc      
      uses: arduino/setup-protoc@v1.1.2
      with:        
        version: 3.16      

    - name: Setup protobuf-go 
      run: > 
          go get google.golang.org/protobuf/cmd/protoc-gen-go
          google.golang.org/grpc/cmd/protoc-gen-go-grpc 
          github.com/ysugimoto/grpc-graphql-gateway/protoc-gen-graphql/...

    - name: Build cloud/registry
      env:
        BUILD_NUMBER: ${{ github.run_number }}
      run: make build
      working-directory: ${{ env.working-directory }}

    - name: Test
      run: go test -v ./... -coverprofile="coverage.out"
      working-directory: ${{ env.working-directory }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Login to Amazon ECR
      run: | 
            aws ecr get-login-password --region us-east-1 | \
            buildah login \
              --username AWS \
              --password-stdin \
              003664043471.dkr.ecr.us-east-1.amazonaws.com

    - name: OCI build and push
      working-directory: ${{ env.working-directory }}
      env:
        REGISTRY: 003664043471.dkr.ecr.us-east-1.amazonaws.com/registry
      run: |                        
            buildah bud -t $REGISTRY\:${{ steps.vars_step.outputs.sha_short }} \
                -t $REGISTRY\:${{ steps.vars_step.outputs.branch }}-${{ github.run_number }} \
                -t $REGISTRY\:latest .  && \
            buildah push $REGISTRY\:${{ steps.vars_step.outputs.branch }}-${{ github.run_number }} && \
            buildah push $REGISTRY\:${{ steps.vars_step.outputs.sha_short }} && \
            buildah push $REGISTRY\:latest 

    - name: OCI Push registry-listener 
      working-directory: ${{ env.working-directory }}
      env:
        REGISTRY: 003664043471.dkr.ecr.us-east-1.amazonaws.com/registry-listener
      run: |                        
            buildah bud -f Dockerfile.listener -t $REGISTRY\:${{ steps.vars_step.outputs.sha_short }} \
                -t $REGISTRY\:${{ steps.vars_step.outputs.branch }}-${{ github.run_number }} \
                -t $REGISTRY\:latest .  && \
            buildah push $REGISTRY\:${{ steps.vars_step.outputs.branch }}-${{ github.run_number }} && \
            buildah push $REGISTRY\:${{ steps.vars_step.outputs.sha_short }} && \
            buildah push $REGISTRY\:latest 

    - name: OCI Push Registry test 
      working-directory: ${{ env.working-directory }}
      env:
        REGISTRY: 003664043471.dkr.ecr.us-east-1.amazonaws.com/registry
      run: |                        
            buildah bud -f Int.Dockerfile -t $REGISTRY\:${{ steps.vars_step.outputs.sha_short }}-test \
                -t $REGISTRY\:${{ steps.vars_step.outputs.branch }}-${{ github.run_number }}-test \
                -t $REGISTRY\:latest-test .  && \
            buildah push $REGISTRY\:${{ steps.vars_step.outputs.branch }}-${{ github.run_number }}-test && \
            buildah push $REGISTRY\:${{ steps.vars_step.outputs.sha_short }}-test && \
            buildah push $REGISTRY\:latest-test

        
    - name: SonarCloud Scan
      uses: sonarsource/sonarcloud-github-action@v1.6
      env:
        GITHUB_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        projectBaseDir:  ${{ env.working-directory }}
        args: >
          -Dsonar.organization=ukama
          -Dsonar.projectKey=ukama_ukamaX_registry
          -Dsonar.projectName=${{ env.working-directory }}
          -Dsonar.go.coverage.reportPaths=coverage.out
          -Dsonar.test.exclusions=tests/**
          -Dsonar.tests=tests/
          -Dsonar.verbose=true
          -Dsonar.sources=.
          -Dsonar.exclusions=**/*_test.go,mocks/**,pb/**
          -Dsonar.tests=.
          -Dsonar.test.inclusions=**/*_test.go

       
  lint:
    name: lint
    runs-on: ubuntu-latest
    env: 
      working-directory: cloud/registry
    steps:
      - uses: actions/checkout@v2

      - name: Granting private modules access
        run: |
            git config --global url."https://none:${{ secrets.GIT_ACCESS_TOKEN }}@github.com/ukama".insteadOf "https://github.com/ukama"     

      - name: lint
        uses: golangci/golangci-lint-action@v2
        with:
            working-directory: ${{ env.working-directory }}
  



  release:
      name: release
      needs: build
      #if: github.ref == 'refs/heads/main'
      runs-on: ubuntu-latest
      env:
        working-directory: cloud/registry
      steps:
        # init vars required for tag generation
        - uses: actions/checkout@v2
        - name: Init vars
          id: vars_step
          run: |
            echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"
            echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"

        - name: update gitops                
          uses: denispalnitsky/gitops-release@v7
          with:
            filename: "releases/ukamax-helmfile.yaml"
            key: "registryImageTag"
            value:  ${{ steps.vars_step.outputs.sha_short }}
            github-token: ${{ secrets.GIT_ACCESS_TOKEN }}
            github-org-and-repo: "ukama/infra-as-code"
