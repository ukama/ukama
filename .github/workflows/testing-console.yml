name: console-testing

on:
 push:
  paths:
   - 'testing/console/**'
   - '.github/workflows/testing-console.yml'
 pull_request:
  paths:
   - 'testing/console/**'
   - '.github/workflows/testing-console.yml'

jobs:
 test:
  name: Run Playwright Tests
  runs-on: ubuntu-latest

  steps:
   - uses: actions/checkout@v4

   - name: Setup Node.js
     uses: actions/setup-node@v4
     with:
      node-version: '20'

   - name: Setup pnpm
     uses: pnpm/action-setup@v2
     with:
      version: 8

   - name: Install OpenVPN
     run: |
      sudo apt-get update
      sudo apt-get install -y openvpn

   - name: Setup VPN
     run: |
      echo "${{ secrets.VPN_CONFIG }}" > vpn.ovpn
      sudo openvpn --config vpn.ovpn --daemon
      sleep 10  # Wait for VPN connection to establish
      curl ifconfig.me  # Verify VPN connection

   - name: Install dependencies
     run: |
      cd testing/console
      pnpm install
      pnpm exec playwright install --with-deps

   - name: Run Playwright tests
     env:
      CONSOLE_BASE_URL: ${{ secrets.CONSOLE_BASE_URL }}
      AUTH_BASE_URL: ${{ secrets.AUTH_BASE_URL }}
      TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
      TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
      LIGHTHOUSE_SCORE_THRESHOLD: ${{ secrets.LIGHTHOUSE_SCORE_THRESHOLD }}
     run: |
      cd testing/console
      mkdir -p test-results
      pnpm test-ci

   - name: Upload test results
     if: always()
     uses: actions/upload-artifact@v4
     with:
      name: playwright-report
      path: testing/console/playwright-report
      retention-days: 30

   - name: Comment PR with report URL
     if: github.event_name == 'pull_request'
     uses: actions/github-script@v7
     with:
      script: |
       const fs = require('fs');
       const reportPath = 'testing/console/playwright-report/index.html';
       const statsPath = 'testing/console/test-results/test-results.json';

       if (fs.existsSync(reportPath)) {
         const runId = context.runId;
         const artifactUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}/artifacts/playwright-report`;
         
         let statsMessage = '';
         if (fs.existsSync(statsPath)) {
           const stats = JSON.parse(fs.readFileSync(statsPath, 'utf8'));
           const total = stats.total;
           const passed = stats.passed;
           const failed = stats.failed;
           const skipped = stats.skipped;
           
           statsMessage = `\n\nüìä Test Results:\n` +
             `- Total Tests: ${total}\n` +
             `- ‚úÖ Passed: ${passed}\n` +
             `- ‚ùå Failed: ${failed}\n` +
             `- ‚è≠Ô∏è Skipped: ${skipped}`;
         }
         
         github.rest.issues.createComment({
           issue_number: context.payload.pull_request.number,
           owner: context.repo.owner,
           repo: context.repo.repo,
           body: `üé≠ Playwright test results are available [here](${artifactUrl})${statsMessage}`
         });
       }

   - name: Cleanup VPN
     if: always()
     run: |
      sudo killall openvpn || true
      rm -f vpn.ovpn
